{% extends 'base.html' %}
{% load static %}

{% block title %}新規イベント作成 - 活動スケジュール{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'events/css/event_form.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-header">
        <h1>新規イベント作成</h1>
        <a href="#" onclick="goBack()" class="back-link">← 戻る</a>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message message-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="form-container">
        <form method="post" class="event-form">
            {% csrf_token %}

            <div class="form-group">
                <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                {{ form.title }}
                {% if form.title.errors %}
                <div class="error-message">{{ form.title.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.start_time.id_for_label }}">{{ form.start_time.label }}</label>
                    {{ form.start_time }}
                    {% if form.start_time.errors %}
                    <div class="error-message">{{ form.start_time.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.end_time.id_for_label }}">{{ form.end_time.label }}</label>
                    {{ form.end_time }}
                    {% if form.end_time.errors %}
                    <div class="error-message">{{ form.end_time.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label for="{{ form.location.id_for_label }}">{{ form.location.label }}</label>
                {{ form.location }}
                {% if form.location.errors %}
                <div class="error-message">{{ form.location.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.errors %}
                <div class="error-message">{{ form.description.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">イベントを作成</button>
                <a href="#" onclick="goBack()" class="btn btn-secondary">キャンセル</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 日時入力のバリデーション
    document.addEventListener('DOMContentLoaded', function() {
        const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');
        const endTimeInput = document.getElementById('{{ form.end_time.id_for_label }}');
        
        // 開始時刻が終了時刻より後にならないようにチェック
        function validateTimes() {
            const startTime = new Date(startTimeInput.value);
            const endTime = new Date(endTimeInput.value);
            
            if (startTime >= endTime) {
                endTimeInput.setCustomValidity('終了時刻は開始時刻より後である必要があります');
            } else {
                endTimeInput.setCustomValidity('');
            }
        }
        
        startTimeInput.addEventListener('change', validateTimes);
        endTimeInput.addEventListener('change', validateTimes);
    });

    // 戻る機能
    function goBack() {
        // 前のページのURLを取得
        const referrer = document.referrer;
        
        // 前のページがない場合や、同じサイトのページでない場合はデフォルトのページに戻る
        if (!referrer || !referrer.includes(window.location.origin)) {
            window.location.href = "{% url 'event_list' %}";
            return;
        }
        
        // 前のページのパスを取得
        const referrerPath = new URL(referrer).pathname;
        
        // 特定のページからの遷移の場合は適切な戻り先を設定
        if (referrerPath.includes('/events/list/')) {
            window.location.href = "{% url 'event_list_view' %}";
        } else if (referrerPath.includes('/events/')) {
            window.location.href = "{% url 'event_list' %}";
        } else {
            // その他の場合は前のページに戻る
            window.history.back();
        }
    }
</script>
{% endblock %}