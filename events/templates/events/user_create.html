{% extends 'base.html' %}
{% load static %}

{% block title %}新規ユーザー登録 - 活動スケジュール{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'events/css/user_form.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-header">
        <h1>新規ユーザー登録</h1>
        <a href="#" onclick="goBack()" class="back-link">← 戻る</a>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message message-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="form-container">
        <form method="post" class="user-form">
            {% csrf_token %}

            <div class="form-group">
                <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                {{ form.name }}
                {% if form.name.errors %}
                <div class="error-message">{{ form.name.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.age.id_for_label }}">{{ form.age.label }}</label>
                    {{ form.age }}
                    {% if form.age.errors %}
                    <div class="error-message">{{ form.age.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.jersey_number.id_for_label }}">{{ form.jersey_number.label }}</label>
                    {{ form.jersey_number }}
                    {% if form.jersey_number.errors %}
                    <div class="error-message">{{ form.jersey_number.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label>{{ form.positions.label }}</label>
                <div class="position-grid">
                    {% for checkbox in form.positions %}
                    <div class="position-checkbox">
                        {{ checkbox.tag }}
                        <label for="{{ checkbox.id_for_label }}" class="position-label">
                            {{ checkbox.choice_label }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% if form.positions.errors %}
                <div class="error-message">{{ form.positions.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">ユーザーを登録</button>
                <a href="#" onclick="goBack()" class="btn btn-secondary">キャンセル</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 年齢と背番号の入力値チェック
    document.addEventListener('DOMContentLoaded', function() {
        const ageInput = document.getElementById('{{ form.age.id_for_label }}');
        const jerseyInput = document.getElementById('{{ form.jersey_number.id_for_label }}');
        
        ageInput.addEventListener('input', function() {
            if (this.value < 1 || this.value > 100) {
                this.setCustomValidity('年齢は1歳から100歳の間で入力してください');
            } else {
                this.setCustomValidity('');
            }
        });
        
        jerseyInput.addEventListener('input', function() {
            if (this.value < 1 || this.value > 99) {
                this.setCustomValidity('背番号は1から99の間で入力してください');
            } else {
                this.setCustomValidity('');
            }
        });
    });

    // 戻る機能
    function goBack() {
        // 前のページのURLを取得
        const referrer = document.referrer;
        
        // 前のページがない場合や、同じサイトのページでない場合はデフォルトのページに戻る
        if (!referrer || !referrer.includes(window.location.origin)) {
            window.location.href = "{% url 'user_list' %}";
            return;
        }
        
        // 前のページのパスを取得
        const referrerPath = new URL(referrer).pathname;
        
        // 特定のページからの遷移の場合は適切な戻り先を設定
        if (referrerPath.includes('/users/')) {
            window.location.href = "{% url 'user_list' %}";
        } else {
            // その他の場合は前のページに戻る
            window.history.back();
        }
    }
</script>
{% endblock %}
